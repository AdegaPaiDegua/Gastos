<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Controle de Gastos com Login</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 0;
            margin: 0;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 15px;
        }
        
        /* Tela de Login */
        #loginScreen {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            background: linear-gradient(135deg, #2c3e50, #4a6491);
        }
        
        .login-card {
            background: white;
            border-radius: 16px;
            padding: 30px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            text-align: center;
        }
        
        .login-card h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1.8rem;
        }
        
        .login-card p {
            color: #666;
            margin-bottom: 25px;
        }
        
        .login-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 25px;
        }
        
        .login-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 16px;
            border-radius: 10px;
            border: none;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .login-btn:active {
            transform: scale(0.98);
        }
        
        .google-btn {
            background: #fff;
            color: #757575;
            border: 1px solid #ddd;
        }
        
        .google-btn:active {
            background: #f5f5f5;
        }
        
        .icloud-btn {
            background: #007aff;
            color: white;
        }
        
        .icloud-btn:active {
            background: #006ee6;
        }
        
        .guest-btn {
            background: transparent;
            color: #4a6491;
            border: 1px solid #4a6491;
            margin-top: 10px;
        }
        
        .guest-btn:active {
            background: rgba(74, 100, 145, 0.1);
        }
        
        /* Conte√∫do principal (inicialmente oculto) */
        #mainContent {
            display: none;
        }
        
        header {
            text-align: center;
            margin-bottom: 20px;
            padding: 20px 15px;
            background: linear-gradient(135deg, #2c3e50, #4a6491);
            color: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            position: relative;
            margin-top: env(safe-area-inset-top);
        }
        
        h1 {
            font-size: 1.8rem;
            margin-bottom: 8px;
            font-weight: 700;
        }
        
        .subtitle {
            font-size: 1rem;
            opacity: 0.9;
            font-weight: 400;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .user-info img {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 2px solid white;
        }
        
        .user-info span {
            font-size: 0.9rem;
        }
        
        .logout-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            cursor: pointer;
            margin-left: 10px;
        }
        
        .main-content {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .section {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        
        h2 {
            margin-bottom: 18px;
            color: #2c3e50;
            padding-bottom: 12px;
            border-bottom: 1px solid #eee;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        h2 i {
            color: #4a6491;
        }
        
        .drop-area {
            border: 2px dashed #4a6491;
            border-radius: 12px;
            padding: 25px 15px;
            text-align: center;
            margin-bottom: 20px;
            transition: all 0.3s;
            cursor: pointer;
            background-color: #f9fbff;
        }
        
        .drop-area:hover, .drop-area:active {
            background-color: #f0f8ff;
        }
        
        .drop-area p {
            margin-top: 12px;
            color: #4a6491;
            font-weight: 500;
            font-size: 1rem;
        }
        
        .drop-area i {
            font-size: 2.5rem;
            color: #4a6491;
            margin-bottom: 10px;
        }
        
        .file-input {
            display: none;
        }
        
        .btn {
            display: block;
            width: 100%;
            background: #4a6491;
            color: white;
            padding: 16px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            transition: background 0.3s;
            margin-top: 12px;
            text-align: center;
        }
        
        .btn:active {
            background: #2c3e50;
            transform: scale(0.98);
        }
        
        .btn-danger {
            background: #e74c3c;
        }
        
        .btn-danger:active {
            background: #c0392b;
        }
        
        .summary-cards {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .card {
            background: linear-gradient(135deg, #4a6491, #2c3e50);
            color: white;
            padding: 18px;
            border-radius: 12px;
            text-align: center;
        }
        
        .card h3 {
            font-size: 1rem;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .card p {
            font-size: 1.6rem;
            font-weight: bold;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 0.9rem;
        }
        
        th, td {
            padding: 12px 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background-color: #4a6491;
            color: white;
            position: sticky;
            top: 0;
        }
        
        tr:last-child td {
            border-bottom: none;
        }
        
        tr:hover {
            background-color: #f5f5f5;
        }
        
        .filters {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .filter-item {
            width: 100%;
        }
        
        .filter-item label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.9rem;
        }
        
        .filter-item input, .filter-item select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            -webkit-appearance: none;
        }
        
        .table-container {
            overflow-x: auto;
            max-height: 400px;
            -webkit-overflow-scrolling: touch;
        }
        
        .negative {
            color: #e74c3c;
            font-weight: 600;
        }
        
        .positive {
            color: #2ecc71;
            font-weight: 600;
        }
        
        .btn-group {
            display: flex;
            gap: 12px;
        }
        
        .btn-group .btn {
            flex: 1;
        }
        
        .instructions {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            font-size: 0.9rem;
        }
        
        .instructions h3 {
            margin-bottom: 10px;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .instructions ul {
            padding-left: 20px;
        }
        
        .instructions li {
            margin-bottom: 8px;
        }
        
        /* iPhone notch safe areas */
        .safe-area-top {
            padding-top: env(safe-area-inset-top);
        }
        
        .safe-area-bottom {
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        /* Loading indicator */
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .loading i {
            font-size: 2rem;
            color: #4a6491;
        }
        
        /* Toast notification */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: white;
            padding: 16px 20px;
            border-radius: 10px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.9rem;
        }
        
        /* Date detection info */
        .date-info {
            background-color: #e8f4fd;
            border-left: 4px solid #2196F3;
            padding: 12px;
            margin: 15px 0;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        .date-info i {
            color: #2196F3;
            margin-right: 8px;
        }
        
        /* Responsive adjustments */
        @media (min-width: 768px) {
            .container {
                max-width: 750px;
                padding: 20px;
            }
            
            .summary-cards {
                flex-direction: row;
            }
            
            .filters {
                flex-direction: row;
            }
            
            .filter-item {
                flex: 1;
            }
        }
    </style>
</head>
<body>
    <!-- Tela de Login -->
    <div id="loginScreen">
        <div class="login-card">
            <h1>Controle de Gastos</h1>
            <p>Fa√ßa login para gerenciar suas finan√ßas</p>
            
            <div class="login-options">
                <button class="login-btn google-btn" id="googleLogin">
                    <i class="fab fa-google"></i>
                    Entrar com Google
                </button>
                
                <button class="login-btn icloud-btn" id="icloudLogin">
                    <i class="fab fa-apple"></i>
                    Entrar com iCloud
                </button>
                
                <button class="login-btn guest-btn" id="guestLogin">
                    <i class="fas fa-user"></i>
                    Entrar como Convidado
                </button>
            </div>
        </div>
    </div>
    
    <!-- Conte√∫do Principal (inicialmente oculto) -->
    <div id="mainContent">
        <div class="safe-area-top"></div>
        <div class="container">
            <header>
                <h1>Controle de Gastos Inteligente</h1>
                <p class="subtitle">Detec√ß√£o autom√°tica de datas da sua planilha</p>
                
                <div class="user-info">
                    <img id="userAvatar" src="https://cdn-icons-png.flaticon.com/512/847/847969.png" alt="Avatar">
                    <span id="userName">Usu√°rio</span>
                    <button class="logout-btn" id="logoutBtn">Sair</button>
                </div>
            </header>
            
            <div class="main-content">
                <section class="section">
                    <h2><i class="fas fa-file-import"></i> Importar Planilha</h2>
                    <div class="drop-area" id="dropArea">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <p>Toque para selecionar sua planilha do Excel</p>
                    </div>
                    <input type="file" id="fileInput" class="file-input" accept=".xlsx, .xls">
                    
                    <div class="btn-group">
                        <button class="btn" id="importBtn">Selecionar Arquivo</button>
                        <button class="btn btn-danger" id="clearBtn">Limpar Tudo</button>
                    </div>
                    
                    <div class="instructions">
                        <h3><i class="fas fa-info-circle"></i> Como usar:</h3>
                        <ul>
                            <li>O sistema detecta automaticamente a coluna de data na sua planilha</li>
                            <li>Suporte para formatos: DD/MM/AAAA, MM/DD/AAAA, AAAA-MM-DD</li>
                            <li>Toque em "Selecionar Arquivo" para importar</li>
                            <li>Os dados ficar√£o salvos no seu dispositivo</li>
                        </ul>
                    </div>
                </section>
                
                <section class="section">
                    <h2><i class="fas fa-chart-pie"></i> Resumo Financeiro</h2>
                    <div class="summary-cards">
                        <div class="card">
                            <h3>Total de Gastos</h3>
                            <p id="totalExpenses">R$ 0,00</p>
                        </div>
                        <div class="card">
                            <h3>Maior Gasto</h3>
                            <p id="highestExpense">R$ 0,00</p>
                        </div>
                        <div class="card">
                            <h3>Gasto M√©dio</h3>
                            <p id="averageExpense">R$ 0,00</p>
                        </div>
                    </div>
                    
                    <div class="date-info">
                        <i class="fas fa-calendar-alt"></i>
                        <span id="dateRangeInfo">Per√≠odo: Nenhum dado dispon√≠vel</span>
                    </div>
                    
                    <div class="filters">
                        <div class="filter-item">
                            <label for="monthFilter">M√™s:</label>
                            <select id="monthFilter">
                                <option value="">Todos os meses</option>
                                <option value="01">Janeiro</option>
                                <option value="02">Fevereiro</option>
                                <option value="03">Mar√ßo</option>
                                <option value="04">Abril</option>
                                <option value="05">Maio</option>
                                <option value="06">Junho</option>
                                <option value="07">Julho</option>
                                <option value="08">Agosto</option>
                                <option value="09">Setembro</option>
                                <option value="10">Outubro</option>
                                <option value="11">Novembro</option>
                                <option value="12">Dezembro</option>
                            </select>
                        </div>
                        <div class="filter-item">
                            <label for="yearFilter">Ano:</label>
                            <select id="yearFilter">
                                <option value="">Todos os anos</option>
                            </select>
                        </div>
                    </div>
                </section>
                
                <section class="section">
                    <h2><i class="fas fa-receipt"></i> Gastos Detalhados</h2>
                    <div class="table-container">
                        <table id="expensesTable">
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>Descri√ß√£o</th>
                                    <th>Categoria</th>
                                    <th>Valor (R$)</th>
                                </tr>
                            </thead>
                            <tbody id="expensesTableBody">
                                <tr>
                                    <td colspan="4" style="text-align: center; padding: 20px;">Nenhum dado dispon√≠vel. Importe uma planilha para come√ßar.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </section>
            </div>
            
            <div class="loading" id="loadingIndicator">
                <i class="fas fa-spinner fa-spin"></i>
                <p>Processando planilha...</p>
            </div>
        </div>
        
        <div class="safe-area-bottom"></div>
        
        <div class="toast" id="toast"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Elementos da interface
            const loginScreen = document.getElementById('loginScreen');
            const mainContent = document.getElementById('mainContent');
            const googleLoginBtn = document.getElementById('googleLogin');
            const icloudLoginBtn = document.getElementById('icloudLogin');
            const guestLoginBtn = document.getElementById('guestLogin');
            const logoutBtn = document.getElementById('logoutBtn');
            const userName = document.getElementById('userName');
            const userAvatar = document.getElementById('userAvatar');
            
            const fileInput = document.getElementById('fileInput');
            const dropArea = document.getElementById('dropArea');
            const importBtn = document.getElementById('importBtn');
            const clearBtn = document.getElementById('clearBtn');
            const monthFilter = document.getElementById('monthFilter');
            const yearFilter = document.getElementById('yearFilter');
            const expensesTableBody = document.getElementById('expensesTableBody');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const toast = document.getElementById('toast');
            const dateRangeInfo = document.getElementById('dateRangeInfo');
            
            const totalExpensesElement = document.getElementById('totalExpenses');
            const highestExpenseElement = document.getElementById('highestExpense');
            const averageExpenseElement = document.getElementById('averageExpense');
            
            let expensesData = [];
            let dateColumnName = '';
            let currentUser = null;
            
            // Verificar se j√° est√° logado
            checkLoginStatus();
            
            // Event listeners para login
            googleLoginBtn.addEventListener('click', () => loginWithGoogle());
            icloudLoginBtn.addEventListener('click', () => loginWithICloud());
            guestLoginBtn.addEventListener('click', () => loginAsGuest());
            logoutBtn.addEventListener('click', () => logout());
            
            // Fun√ß√µes de login (simuladas para demonstra√ß√£o)
            function loginWithGoogle() {
                showLoading();
                setTimeout(() => {
                    currentUser = {
                        name: 'Usu√°rio Google',
                        email: 'usuario@gmail.com',
                        avatar: 'https://cdn-icons-png.flaticon.com/512/300/300221.png',
                        provider: 'google'
                    };
                    
                    completeLogin();
                    showToast('Login com Google realizado!');
                }, 1000);
            }
            
            function loginWithICloud() {
                showLoading();
                setTimeout(() => {
                    currentUser = {
                        name: 'Usu√°rio iCloud',
                        email: 'usuario@icloud.com',
                        avatar: 'https://cdn-icons-png.flaticon.com/512/0/747.png',
                        provider: 'icloud'
                    };
                    
                    completeLogin();
                    showToast('Login com iCloud realizado!');
                }, 1000);
            }
            
            function loginAsGuest() {
                showLoading();
                setTimeout(() => {
                    currentUser = {
                        name: 'Convidado',
                        email: '',
                        avatar: 'https://cdn-icons-png.flaticon.com/512/847/847969.png',
                        provider: 'guest'
                    };
                    
                    completeLogin();
                    showToast('Modo convidado ativado!');
                }, 800);
            }
            
            function completeLogin() {
                // Salvar informa√ß√µes do usu√°rio
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                
                // Atualizar UI
                userName.textContent = currentUser.name;
                userAvatar.src = currentUser.avatar;
                
                // Mostrar conte√∫do principal
                loginScreen.style.display = 'none';
                mainContent.style.display = 'block';
                
                hideLoading();
                
                // Carregar dados do usu√°rio
                loadUserData();
            }
            
            function logout() {
                if (confirm('Tem certeza que deseja sair?')) {
                    localStorage.removeItem('currentUser');
                    localStorage.removeItem('userExpensesData');
                    
                    currentUser = null;
                    expensesData = [];
                    
                    // Voltar para tela de login
                    mainContent.style.display = 'none';
                    loginScreen.style.display = 'flex';
                    
                    showToast('Logout realizado com sucesso');
                }
            }
            
            function checkLoginStatus() {
                const savedUser = localStorage.getItem('currentUser');
                if (savedUser) {
                    currentUser = JSON.parse(savedUser);
                    userName.textContent = currentUser.name;
                    userAvatar.src = currentUser.avatar;
                    
                    loginScreen.style.display = 'none';
                    mainContent.style.display = 'block';
                    
                    loadUserData();
                }
            }
            
            function loadUserData() {
                const userDataKey = currentUser ? `userExpensesData_${currentUser.provider}_${currentUser.email}` : 'userExpensesData';
                const storedData = localStorage.getItem(userDataKey);
                
                if (storedData) {
                    expensesData = JSON.parse(storedData);
                }
                
                const storedDateColumn = localStorage.getItem('dateColumnName');
                if (storedDateColumn) {
                    dateColumnName = storedDateColumn;
                }
                
                updateUI();
            }
            
            // Event Listeners para touch devices
            dropArea.addEventListener('click', () => fileInput.click());
            importBtn.addEventListener('click', () => fileInput.click());
            
            fileInput.addEventListener('change', () => {
                if (fileInput.files.length) {
                    showLoading();
                    setTimeout(() => {
                        handleFile(fileInput.files[0]);
                        hideLoading();
                    }, 800);
                }
            });
            
            clearBtn.addEventListener('click', () => {
                if (confirm('Tem certeza que deseja limpar todos os dados?')) {
                    const userDataKey = currentUser ? `userExpensesData_${currentUser.provider}_${currentUser.email}` : 'userExpensesData';
                    localStorage.removeItem(userDataKey);
                    
                    expensesData = [];
                    dateColumnName = '';
                    updateUI();
                    showToast('Dados limpos com sucesso');
                }
            });
            
            monthFilter.addEventListener('change', updateUI);
            yearFilter.addEventListener('change', updateUI);
            
            // Fun√ß√£o para processar o arquivo Excel
            function handleFile(file) {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        
                        // Supondo que a primeira planilha √© a que cont√©m os dados
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        
                        // Converter para JSON
                        const jsonData = XLSX.utils.sheet_to_json(worksheet);
                        
                        // Processar os dados
                        processExpensesData(jsonData, worksheet);
                        showToast('Planilha importada com sucesso!');
                    } catch (error) {
                        console.error('Erro ao processar arquivo:', error);
                        showToast('Erro ao processar o arquivo');
                    }
                };
                
                reader.onerror = function() {
                    hideLoading();
                    showToast('Erro ao ler o arquivo');
                };
                
                reader.readAsArrayBuffer(file);
            }
            
            // Fun√ß√£o para detectar automaticamente a coluna de data
            function detectDateColumn(data, worksheet) {
                if (!data || data.length === 0) return null;
                
                // Primeiro, verifica os cabe√ßalhos da planilha
                const range = XLSX.utils.decode_range(worksheet['!ref']);
                const possibleDateHeaders = ['data', 'date', 'data', 'fecha', 'datum', 'Êó•Êúü', 'Êó•‰ªò'];
                
                for (let C = range.s.c; C <= range.e.c; ++C) {
                    const cellAddress = XLSX.utils.encode_cell({c: C, r: 0});
                    const cell = worksheet[cellAddress];
                    
                    if (cell && cell.v) {
                        const header = String(cell.v).toLowerCase().trim();
                        if (possibleDateHeaders.includes(header)) {
                            return header;
                        }
                    }
                }
                
                // Se n√£o encontrou pelos cabe√ßalhos, tenta detectar pelo conte√∫do
                const firstRow = data[0];
                for (const key in firstRow) {
                    const value = firstRow[key];
                    if (typeof value === 'string' || typeof value === 'number') {
                        const strValue = String(value);
                        
                        // Verifica se parece com uma data
                        if (
                            // Formato DD/MM/AAAA ou DD-MM-AAAA
                            /^\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4}$/.test(strValue) ||
                            // Formato AAAA-MM-DD
                            /^\d{4}[\/\-]\d{1,2}[\/\-]\d{1,2}$/.test(strValue) ||
                            // Formato DD de M√™s de AAAA (em portugu√™s)
                            /^\d{1,2} de (janeiro|fevereiro|mar√ßo|abril|maio|junho|julho|agosto|setembro|outubro|novembro|dezembro) de \d{4}$/i.test(strValue)
                        ) {
                            return key;
                        }
                    }
                }
                
                return null;
            }
            
            // Fun√ß√£o para processar os dados da planilha
            function processExpensesData(data, worksheet) {
                // Limpar dados existentes
                expensesData = [];
                
                // Detectar automaticamente a coluna de data
                dateColumnName = detectDateColumn(data, worksheet);
                
                if (!dateColumnName) {
                    showToast('N√£o foi poss√≠vel detectar a coluna de data');
                    return;
                }
                
                // Para cada linha da planilha, criar um objeto de despesa
                data.forEach(row => {
                    // Tenta encontrar as colunas independentemente do caso (mai√∫sculo/min√∫sculo)
                    const keys = Object.keys(row);
                    const descKey = keys.find(k => k.toLowerCase().includes('desc'));
                    const categoryKey = keys.find(k => k.toLowerCase().includes('categ'));
                    const amountKey = keys.find(k => k.toLowerCase().includes('valor') || k.toLowerCase().includes('amount'));
                    
                    const expense = {
                        date: row[dateColumnName] || '',
                        description: row[descKey] || '',
                        category: row[categoryKey] || 'Outros',
                        amount: parseFloat(row[amountKey] || 0)
                    };
                    
                    if (expense.date && expense.description && !isNaN(expense.amount)) {
                        // Formatar a data para um formato padr√£o
                        expense.date = formatDate(expense.date);
                        expensesData.push(expense);
                    }
                });
                
                // Salvar no localStorage
                saveUserData();
                
                // Atualizar a UI
                updateUI();
            }
            
            // Fun√ß√£o para formatar datas de diferentes formatos para DD/MM/AAAA
            function formatDate(dateValue) {
                if (!dateValue) return '';
                
                // Se j√° √© uma string no formato correto
                if (typeof dateValue === 'string' && /^\d{2}\/\d{2}\/\d{4}$/.test(dateValue)) {
                    return dateValue;
                }
                
                // Se for um n√∫mero (serial date do Excel)
                if (typeof dateValue === 'number') {
                    const excelEpoch = new Date(1899, 11, 30);
                    const date = new Date(excelEpoch.getTime() + dateValue * 86400000);
                    return `${String(date.getDate()).padStart(2, '0')}/${String(date.getMonth() + 1).padStart(2, '0')}/${date.getFullYear()}`;
                }
                
                // Converter para string se n√£o for
                const dateStr = String(dateValue);
                
                // Tentar diferentes formatos de data
                try {
                    // Formato AAAA-MM-DD
                    if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
                        const [year, month, day] = dateStr.split('-');
                        return `${day}/${month}/${year}`;
                    }
                    
                    // Formato DD/MM/AAAA
                    if (/^\d{2}\/\d{2}\/\d{4}$/.test(dateStr)) {
                        return dateStr;
                    }
                    
                    // Formato DD-MM-AAAA
                    if (/^\d{2}-\d{2}-\d{4}$/.test(dateStr)) {
                        return dateStr.replace(/-/g, '/');
                    }
                    
                    // Formato MM/DD/AAAA
                    if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(dateStr)) {
                        const [month, day, year] = dateStr.split('/');
                        return `${day.padStart(2, '0')}/${month.padStart(2, '0')}/${year}`;
                    }
                    
                    // Se n√£o reconheceu o formato, retorna o valor original
                    return dateStr;
                } catch (error) {
                    console.error('Erro ao formatar data:', error, dateValue);
                    return dateStr;
                }
            }
            
            // Salvar dados no localStorage com chave espec√≠fica do usu√°rio
            function saveUserData() {
                const userDataKey = currentUser ? `userExpensesData_${currentUser.provider}_${currentUser.email}` : 'userExpensesData';
                localStorage.setItem(userDataKey, JSON.stringify(expensesData));
                localStorage.setItem('dateColumnName', dateColumnName);
            }
            
            // Atualizar a interface com os dados
            function updateUI() {
                // Aplicar filtros
                const month = monthFilter.value;
                const year = yearFilter.value;
                
                let filteredData = expensesData;
                
                if (month) {
                    filteredData = filteredData.filter(expense => {
                        if (!expense.date) return false;
                        const expenseMonth = expense.date.split('/')[1];
                        return expenseMonth === month;
                    });
                }
                
                if (year) {
                    filteredData = filteredData.filter(expense => {
                        if (!expense.date) return false;
                        const expenseYear = expense.date.split('/')[2];
                        return expenseYear === year;
                    });
                }
                
                // Atualizar a tabela
                expensesTableBody.innerHTML = '';
                
                if (filteredData.length === 0) {
                    expensesTableBody.innerHTML = `
                        <tr>
                            <td colspan="4" style="text-align: center; padding: 20px;">
                                ${expensesData.length === 0 ? 'Nenhum dado dispon√≠vel. Importe uma planilha para come√ßar.' : 'Nenhum resultado encontrado com os filtros atuais.'}
                            </td>
                        </tr>
                    `;
                } else {
                    filteredData.forEach(expense => {
                        const row = document.createElement('tr');
                        
                        row.innerHTML = `
                            <td>${expense.date}</td>
                            <td>${expense.description}</td>
                            <td>${expense.category}</td>
                            <td class="${expense.amount < 0 ? 'negative' : 'positive'}">R$ ${expense.amount.toFixed(2)}</td>
                        `;
                        
                        expensesTableBody.appendChild(row);
                    });
                }
                
                // Atualizar estat√≠sticas
                updateSummary(filteredData);
                
                // Atualizar informa√ß√µes de data
                updateDateInfo();
                
                // Atualizar op√ß√µes de ano
                updateYearFilter();
            }
            
            // Atualizar o resumo financeiro
            function updateSummary(data) {
                if (data.length === 0) {
                    totalExpensesElement.textContent = 'R$ 0,00';
                    highestExpenseElement.textContent = 'R$ 0,00';
                    averageExpenseElement.textContent = 'R$ 0,00';
                    return;
                }
                
                const total = data.reduce((sum, expense) => sum + expense.amount, 0);
                const highest = Math.max(...data.map(expense => expense.amount));
                const average = total / data.length;
                
                totalExpensesElement.textContent = `R$ ${total.toFixed(2)}`;
                highestExpenseElement.textContent = `R$ ${highest.toFixed(2)}`;
                averageExpenseElement.textContent = `R$ ${average.toFixed(2)}`;
            }
            
            // Atualizar informa√ß√µes do per√≠odo de datas
            function updateDateInfo() {
                if (expensesData.length === 0) {
                    dateRangeInfo.textContent = 'Per√≠odo: Nenhum dado dispon√≠vel';
                    return;
                }
                
                // Encontrar a data mais antiga e mais recente
                const dates = expensesData
                    .map(expense => {
                        if (!expense.date) return null;
                        const [day, month, year] = expense.date.split('/').map(Number);
                        return new Date(year, month - 1, day);
                    })
                    .filter(date => date instanceof Date && !isNaN(date));
                
                if (dates.length === 0) {
                    dateRangeInfo.textContent = 'Per√≠odo: Datas n√£o identificadas';
                    return;
                }
                
                const minDate = new Date(Math.min(...dates));
                const maxDate = new Date(Math.max(...dates));
                
                const formatOptions = { day: '2-digit', month: '2-digit', year: 'numeric' };
                const startDate = minDate.toLocaleDateString('pt-BR', formatOptions);
                const endDate = maxDate.toLocaleDateString('pt-BR', formatOptions);
                
                dateRangeInfo.textContent = `Per√≠odo: ${startDate} a ${endDate}`;
            }
            
            // Atualizar o filtro de anos
            function updateYearFilter() {
                if (expensesData.length === 0) {
                    yearFilter.innerHTML = '<option value="">Todos os anos</option>';
                    return;
                }
                
                // Coletar todos os anos √∫nicos
                const years = [...new Set(expensesData.map(expense => {
                    if (!expense.date) return null;
                    return expense.date.split('/')[2];
                }))].filter(year => year).sort((a, b) => b - a);
                
                // Salvar a sele√ß√£o atual
                const currentSelection = yearFilter.value;
                
                // Limpar e repopular o dropdown
                yearFilter.innerHTML = '<option value="">Todos os anos</option>';
                
                years.forEach(year => {
                    if (year) {
                        const option = document.createElement('option');
                        option.value = year;
                        option.textContent = year;
                        yearFilter.appendChild(option);
                    }
                });
                
                // Restaurar a sele√ß√£o anterior, se ainda existir
                if (years.includes(currentSelection)) {
                    yearFilter.value = currentSelection;
                }
            }
            
            // Mostrar indicador de carregamento
            function showLoading() {
                loadingIndicator.style.display = 'block';
            }
            
            // Esconder indicador de carregamento
            function hideLoading() {
                loadingIndicator.style.display = 'none';
            }
            
            // Mostrar notifica√ß√£o toast
            function showToast(message) {
                toast.textContent = message;
                toast.style.opacity = '1';
                
                setTimeout(() => {
                    toast.style.opacity = '0';
                }, 3000);
            }
        });
    </script>
</body>
</html>